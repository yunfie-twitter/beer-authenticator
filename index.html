<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beer Authenticator - TOTP認証器</title>
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.13.1/dist/cdn/beer.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.13.1/dist/cdn/beer.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/otpauth@9.2.2/dist/otpauth.umd.js"></script>
</head>
<body>
    <!-- App Bar -->
    <header>
        <nav>
            <button class="circle transparent">
                <i>lock</i>
            </button>
            <h6 class="max">Beer Authenticator</h6>
            <button class="circle transparent" onclick="toggleSettings()">
                <i>settings</i>
            </button>
        </nav>
    </header>

    <main>
        <div class="row">
            <!-- Add Account Panel -->
            <article class="s12 m6" id="add-panel">
                <div class="tabs min">
                    <a class="vertical" onclick="switchTab(event, 'qr')"><i>qr_code_2</i>QRコード</a>
                    <a class="vertical active" onclick="switchTab(event, 'manual')"><i>edit</i>手入力</a>
                </div>

                <!-- QR Code Tab -->
                <div class="page padding left" id="qr-page">
                    <h5>QRコードから追加</h5>
                    <p>Google Authenticator や Microsoft Authenticator などのサービスから表示される QR コードを読み込んでください。</p>
                    
                    <div class="field label border" style="margin-top: 20px;">
                        <input type="file" id="qr-file" accept="image/*" />
                        <label>QRコード画像</label>
                    </div>

                    <p style="margin: 20px 0; opacity: 0.7; text-align: center;">または</p>

                    <div class="field label border">
                        <input type="file" id="qr-camera" accept="image/*" capture="environment" />
                        <label>カメラで撮影</label>
                    </div>

                    <button onclick="readQRCode()" style="margin-top: 16px;">
                        <i>upload</i>
                        QRコードを読み込む
                    </button>
                    <canvas id="qr-canvas" style="display: none;"></canvas>
                </div>

                <!-- Manual Input Tab -->
                <div class="page padding left active" id="manual-page">
                    <h5>手動で追加</h5>
                    <p>シークレットキーを直接入力して追加できます。</p>
                    
                    <div class="field label border" style="margin-top: 20px;">
                        <input type="text" id="account-name" placeholder=" " />
                        <label>アカウント名</label>
                        <output>例: GitHub, Gmail, AWS</output>
                    </div>

                    <div class="field label border">
                        <input type="text" id="issuer-name" placeholder=" " />
                        <label>発行者 (オプション)</label>
                        <output>例: github.com, google.com</output>
                    </div>

                    <div class="field label border">
                        <input type="text" id="secret-key" placeholder=" " />
                        <label>シークレットキー</label>
                        <output>Base32 エンコードされたキーを入力してください</output>
                    </div>

                    <button onclick="addAccountManual()" style="margin-top: 16px;">
                        <i>add</i>
                        アカウントを追加
                    </button>
                </div>
            </article>

            <!-- Accounts List Panel -->
            <article class="s12 m6" id="list-panel">
                <h5>登録済みアカウント</h5>
                <p style="opacity: 0.7;">
                    <strong id="account-count">0</strong> 個のアカウントが登録されています
                </p>

                <div id="accounts-container" style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                    <div style="padding: 32px 16px; text-align: center; opacity: 0.6;">
                        <p>アカウントがまだ登録されていません</p>
                        <p style="font-size: 0.9em;">左のパネルから追加してください</p>
                    </div>
                </div>
            </article>
        </div>
    </main>

    <script>
        const STORAGE_KEY = 'beer-authenticator-accounts';
        let accounts = [];

        // Tab switching
        function switchTab(e, tabName) {
            e.preventDefault();
            
            // Update tab buttons
            const addPanel = document.getElementById('add-panel');
            addPanel.querySelectorAll('.tabs a').forEach(btn => btn.classList.remove('active'));
            e.target.closest('a').classList.add('active');
            
            // Update pages
            addPanel.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(`${tabName}-page`).classList.add('active');
        }

        // Load accounts from localStorage
        function loadAccounts() {
            const stored = localStorage.getItem(STORAGE_KEY);
            accounts = stored ? JSON.parse(stored) : [];
            renderAccounts();
        }

        // Save accounts to localStorage
        function saveAccounts() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(accounts));
            renderAccounts();
        }

        // Add account from manual input
        function addAccountManual() {
            const name = document.getElementById('account-name').value.trim();
            const issuer = document.getElementById('issuer-name').value.trim();
            const secret = document.getElementById('secret-key').value.trim().toUpperCase().replace(/\s/g, '');

            if (!name || !secret) {
                alert('アカウント名とシークレットキーは必須です');
                return;
            }

            if (!/^[A-Z2-7=]+$/.test(secret)) {
                alert('シークレットキーは Base32 形式である必要があります');
                return;
            }

            const account = {
                id: Date.now(),
                name,
                issuer: issuer || name,
                secret,
                createdAt: new Date().toISOString()
            };

            accounts.push(account);
            saveAccounts();

            document.getElementById('account-name').value = '';
            document.getElementById('issuer-name').value = '';
            document.getElementById('secret-key').value = '';
        }

        // Read QR Code
        function readQRCode() {
            const fileInput = document.getElementById('qr-file');
            const cameraInput = document.getElementById('qr-camera');
            const file = fileInput.files[0] || cameraInput.files[0];

            if (!file) {
                alert('ファイルを選択してください');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('qr-canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);

                    if (code) {
                        parseOTPAuth(code.data);
                    } else {
                        alert('QR コードが読み込めません');
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Parse otpauth:// URI
        function parseOTPAuth(uri) {
            try {
                const auth = OTPAuth.URI.parse(uri);
                const account = {
                    id: Date.now(),
                    name: auth.label || 'Unknown',
                    issuer: auth.issuer || 'Unknown',
                    secret: auth.secret.base32,
                    createdAt: new Date().toISOString()
                };

                accounts.push(account);
                saveAccounts();

                document.getElementById('qr-file').value = '';
                document.getElementById('qr-camera').value = '';
            } catch (error) {
                alert('QR コードの解析に失敗しました: ' + error.message);
            }
        }

        // Generate TOTP code
        function generateTOTP(secret) {
            try {
                const auth = new OTPAuth.TOTP({
                    secret: OTPAuth.Secret.fromBase32(secret),
                });
                return auth.generate();
            } catch (error) {
                console.error('TOTP生成エラー:', error);
                return 'エラー';
            }
        }

        // Get remaining time
        function getRemainingTime() {
            return 30 - (Math.floor(Date.now() / 1000) % 30);
        }

        // Escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Render accounts
        function renderAccounts() {
            const container = document.getElementById('accounts-container');
            document.getElementById('account-count').textContent = accounts.length;

            if (accounts.length === 0) {
                container.innerHTML = `
                    <div style="padding: 32px 16px; text-align: center; opacity: 0.6;">
                        <p>アカウントがまだ登録されていません</p>
                        <p style="font-size: 0.9em;">左のパネルから追加してください</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = accounts.map(account => `
                <article>
                    <h6 style="margin: 0 0 4px 0;">${escapeHtml(account.name)}</h6>
                    <p style="margin: 0 0 12px 0; opacity: 0.7; font-size: 0.85em;">${escapeHtml(account.issuer)}</p>
                    
                    <div style="background: var(--surface-dim); border-radius: 8px; padding: 16px; margin-bottom: 12px; text-align: center;">
                        <code id="code-${account.id}" style="font-size: 1.8em; font-weight: bold; letter-spacing: 4px; font-family: monospace;">${generateTOTP(account.secret)}</code>
                    </div>

                    <progress id="progress-${account.id}" class="circle wavy" value="${(getRemainingTime() / 30) * 100}" max="100" style="margin-bottom: 12px;"></progress>

                    <nav class="center-align tiny-space">
                        <button class="outline" onclick="copyToClipboard('${account.id}')" style="flex: 1;">
                            <i>content_copy</i>
                        </button>
                        <button class="outline" onclick="deleteAccount(${account.id})" style="flex: 1;">
                            <i>delete</i>
                        </button>
                    </nav>
                </article>
            `).join('');
        }

        // Copy to clipboard
        function copyToClipboard(accountId) {
            const codeElement = document.getElementById(`code-${accountId}`);
            const code = codeElement.textContent;
            navigator.clipboard.writeText(code);
        }

        // Delete account
        function deleteAccount(id) {
            if (confirm('このアカウントを削除しますか？')) {
                accounts = accounts.filter(a => a.id !== id);
                saveAccounts();
            }
        }

        // Settings toggle
        function toggleSettings() {
            // Placeholder for future settings
        }

        // Update TOTP codes every 100ms
        setInterval(() => {
            accounts.forEach(account => {
                const codeElement = document.getElementById(`code-${account.id}`);
                const progressElement = document.getElementById(`progress-${account.id}`);
                
                if (codeElement) {
                    codeElement.textContent = generateTOTP(account.secret);
                }
                
                if (progressElement) {
                    const remainingTime = getRemainingTime();
                    const percentage = (remainingTime / 30) * 100;
                    progressElement.setAttribute('value', percentage);
                }
            });
        }, 100);

        // Initial load
        loadAccounts();
    </script>
</body>
</html>